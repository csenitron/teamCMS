<!-- Модуль меню - {{ menu_title }} -->
<nav class="menu-module menu-style-{{ menu_style }}" id="menu-{{ module_instance.id }}">
    
    {% if menu_style == 'horizontal' %}
        <!-- Горизонтальное меню -->
        <div class="horizontal-menu">
            <ul class="menu-list">
                {% for item in menu_tree %}
                    <li class="menu-item {{ item.custom_class }}{% if item.is_featured %} featured{% endif %}">
                        <a href="{{ item.url }}" 
                           class="menu-link"
                           {% if item.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                           
                            {% if show_icons and item.icon %}
                                <img src="{{ item.icon.url }}" alt="{{ item.title }}" class="menu-icon">
                            {% endif %}
                            
                            <span class="menu-text">{{ item.title }}</span>
                            
                            {% if item.children %}
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            {% endif %}
                        </a>
                        
                        {% if item.children %}
                            <ul class="submenu">
                                {% for child in item.children %}
                                    <li class="submenu-item {{ child.custom_class }}">
                                        <a href="{{ child.url }}" 
                                           class="submenu-link"
                                           {% if child.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                           
                                            {% if show_icons and child.icon %}
                                                <img src="{{ child.icon.url }}" alt="{{ child.title }}" class="submenu-icon">
                                            {% endif %}
                                            
                                            <span class="submenu-text">{{ child.title }}</span>
                                        </a>
                                        
                                        {% if child.children %}
                                            <ul class="sub-submenu">
                                                {% for grandchild in child.children %}
                                                    <li class="sub-submenu-item">
                                                        <a href="{{ grandchild.url }}" 
                                                           class="sub-submenu-link"
                                                           {% if grandchild.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                                            {{ grandchild.title }}
                                                        </a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
        
    {% elif menu_style == 'vertical' %}
        <!-- Вертикальное меню -->
        <div class="vertical-menu">
            <ul class="menu-list vertical">
                {% for item in menu_tree %}
                    <li class="menu-item {{ item.custom_class }}{% if item.is_featured %} featured{% endif %}">
                        <a href="{{ item.url }}" 
                           class="menu-link"
                           {% if item.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                           
                            {% if show_icons and item.icon %}
                                <img src="{{ item.icon.url }}" alt="{{ item.title }}" class="menu-icon">
                            {% endif %}
                            
                            <span class="menu-text">{{ item.title }}</span>
                            
                            {% if item.children %}
                                <i class="fas fa-chevron-right expand-arrow"></i>
                            {% endif %}
                        </a>
                        
                        {% if item.children %}
                            <ul class="submenu vertical">
                                {% for child in item.children %}
                                    <li class="submenu-item">
                                        <a href="{{ child.url }}" 
                                           class="submenu-link"
                                           {% if child.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                            {{ child.title }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
        
    {% elif menu_style == 'mega' %}
    <!-- Мегаменю в стиле Pangaia -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container-fluid">
        <!-- Основное меню для десктопа -->
        <ul class="menu-list mega d-none d-lg-flex navbar-nav me-auto mb-2 mb-lg-0">
                    {% for item in menu_tree %}
                            <li class="nav-item dropdown dropdown-mega">
                    <a href="{{ item.url or '#' }}"
                       class="nav-link dropdown-toggle {{ item.custom_class }}{% if item.is_featured %} featured{% endif %}"
                       {% if item.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}
                       {% if item.children %}role="button" data-bs-toggle="dropdown" aria-expanded="false"{% endif %}>
                                    {% if show_icons and item.icon %}
                            <img src="{{ item.icon.url }}" alt="{{ item.title }}" class="menu-icon me-2">
                                    {% endif %}
                        <span class="menu-text">{{ item.title }}</span>
                        {% if item.children %}
                            <i class="fas fa-chevron-down dropdown-arrow ms-1"></i>
                        {% endif %}
                    </a>
                    {% if item.children %}
                        <div class="dropdown-menu" aria-labelledby="{{ item.title|lower|replace(' ', '') }}Menu">
                            <!-- Видео секция (абсолютное позиционирование) -->
                                            {% if enable_videos and item.video %}
                            <div class="mega-video">
                                <video autoplay muted loop playsinline>
                                                            <source src="{{ item.video.url }}" type="video/mp4">
                                                        </video>
                                                    </div>
                            {% endif %}

                            <!-- Контент секция -->
                            <div class="mega-content-container">
                                <div class="mega-content">
                                                    <div class="row">
                                    <!-- Featured секция -->
                                    {% if item.children and item.children[0] %}
                                    <div class="col-2">
                                        <h6>Featured</h6>
                                        <ul class="mb-4">
                                            {% for child in item.children[:4] %}
                                            <li>
                                                <a href="{{ child.url or '#' }}" {% if child.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                                    {{ child.title }}
                                                </a>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    <!-- Categories секция -->
                                    {% if item.children %}
                                    <div class="col-2">
                                        <h6>Categories</h6>
                                        <ul class="mb-4">
                                                        {% for child in item.children %}
                                            <li>
                                                <a href="{{ child.url or '#' }}" {% if child.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                                                        {{ child.title }}
                                                                                </a>
                                                                            </li>
                                                                        {% endfor %}
                                                                    </ul>
                                    </div>
                                                                {% endif %}

                                    <!-- Shop by color секция -->
                                    <div class="col-2">
                                        <h6>Shop by color</h6>
                                        <ul class="mb-4">
                                            <li><a href="#">Black</a></li>
                                            <li><a href="#">White</a></li>
                                            <li><a href="#">Blue</a></li>
                                            <li><a href="#">Grey</a></li>
                                            <li><a href="#">Neutral</a></li>
                                            <li><a href="#">Pink</a></li>
                                            <li><a href="#">Purple</a></li>
                                            <li><a href="#">Red</a></li>
                                            <li><a href="#">Green</a></li>
                                        </ul>
                                                            </div>

                                    <!-- Capsule секция -->
                                    <div class="col-2">
                                        <h6>Capsule</h6>
                                        <ul class="mb-4">
                                            <li><a href="#">365 Heavyweight</a></li>
                                            <li><a href="#">365 Midweight</a></li>
                                            <li><a href="#">DNA</a></li>
                                        </ul>
                                                    </div>
                                                </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <!-- Мобильное меню на offcanvas Bootstrap -->
        <div class="d-lg-none">
            <button class="btn btn-outline-dark mobile-menu-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenuOffcanvas" aria-controls="mobileMenuOffcanvas">
                <i class="fas fa-bars"></i>
                <span class="visually-hidden">Меню</span>
            </button>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenuOffcanvas" aria-labelledby="mobileMenuOffcanvasLabel">
                <div class="offcanvas-header border-bottom">
                    <h5 class="offcanvas-title" id="mobileMenuOffcanvasLabel">{{ menu_title or 'Меню' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body p-0">
                    <div class="accordion accordion-flush" id="mobileMenuAccordion">
                        {% for item in menu_tree %}
                            <div class="accordion-item">
                                {% if item.children %}
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index0 }}">
                                            {% if show_icons and item.icon %}
                                                <img src="{{ item.icon.url }}" alt="{{ item.title }}" class="menu-icon me-2" width="20" height="20">
                                            {% endif %}
                                            {{ item.title }}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ loop.index0 }}" class="accordion-collapse collapse" data-bs-parent="#mobileMenuAccordion">
                                        <div class="accordion-body p-0">
                                                {% for child in item.children %}
                                                            <a href="{{ child.url or '#' }}" 
                                                   class="d-block p-3 text-decoration-none text-dark border-bottom"
                                                               {% if child.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                                                {{ child.title }}
                                                            </a>
                                                        {% if child.children %}
                                                    <div class="ps-4">
                                                                {% for subchild in child.children %}
                                                                        <a href="{{ subchild.url or '#' }}" 
                                                               class="d-block p-2 text-decoration-none text-muted small border-bottom"
                                                                           {% if subchild.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                                                            {{ subchild.title }}
                                                                        </a>
                                                                {% endfor %}
                                                    </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                        {% else %}
                                    <div class="p-3 border-bottom">
                                        <a href="{{ item.url or '#' }}" 
                                           class="text-decoration-none text-dark d-flex align-items-center"
                                   {% if item.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                    {% if show_icons and item.icon %}
                                                <img src="{{ item.icon.url }}" alt="{{ item.title }}" class="menu-icon me-2" width="20" height="20">
                                    {% endif %}
                                    {{ item.title }}
                                </a>
                                    </div>
                        {% endif %}
                            </div>
                    {% endfor %}
            </div>
            </div>
        </div>
        </div>
    </div>
        
    {% elif menu_style == 'mobile' %}
        <!-- Мобильное меню -->
        <div class="mobile-menu">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span class="hamburger"></span>
                <span class="hamburger"></span>
                <span class="hamburger"></span>
            </button>
            
            <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
            
            <div class="mobile-menu-content" id="mobileMenuContent">
                <div class="mobile-menu-header">
                    <h4>{{ menu_title }}</h4>
                    <button class="mobile-menu-close" onclick="closeMobileMenu()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <ul class="mobile-menu-list">
                    {% for item in menu_tree %}
                        <li class="mobile-menu-item {{ item.custom_class }}{% if item.is_featured %} featured{% endif %}">
                            <div class="mobile-menu-link-wrapper">
                                <a href="{{ item.url }}" 
                                   class="mobile-menu-link"
                                   {% if item.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                   
                                    {% if show_icons and item.icon %}
                                        <img src="{{ item.icon.url }}" alt="{{ item.title }}" class="mobile-menu-icon">
                                    {% endif %}
                                    
                                    <span class="mobile-menu-text">{{ item.title }}</span>
                                </a>
                                
                                {% if item.children %}
                                    <button class="mobile-submenu-toggle" onclick="toggleMobileSubmenu({{ loop.index0 }})">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                {% endif %}
                            </div>
                            
                            {% if item.children %}
                                <ul class="mobile-submenu" id="submenu-{{ loop.index0 }}">
                                    {% for child in item.children %}
                                        <li class="mobile-submenu-item">
                                            <a href="{{ child.url }}" 
                                               class="mobile-submenu-link"
                                               {% if child.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                                                {{ child.title }}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
</nav>

<style>
/* Базовые стили меню */
.menu-module {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.menu-link, .submenu-link, .sub-submenu-link, .mobile-menu-link, .mobile-submenu-link {
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
}

.menu-icon, .submenu-icon, .mobile-menu-icon {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    vertical-align: middle;
}

/* Горизонтальное меню */
.horizontal-menu .menu-list {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.horizontal-menu .menu-item {
    position: relative;
}

.horizontal-menu .menu-link {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    color: #333;
    border-bottom: 3px solid transparent;
}

.horizontal-menu .menu-link:hover {
    background: #f8f9fa;
    border-bottom-color: #007bff;
}

.horizontal-menu .submenu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 200px;
    background: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    list-style: none;
    margin: 0;
    padding: 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.horizontal-menu .menu-item:hover .submenu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.horizontal-menu .submenu-link {
    display: block;
    padding: 12px 20px;
    color: #333;
}

.horizontal-menu .submenu-link:hover {
    background: #f8f9fa;
    color: #007bff;
}

/* Вертикальное меню */
.vertical-menu {
    width: 250px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
}

.vertical-menu .menu-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.vertical-menu .menu-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
}

.vertical-menu .menu-link:hover {
    background: #f8f9fa;
    color: #007bff;
}

.vertical-menu .submenu {
    list-style: none;
    margin: 0;
    padding: 0;
    background: #f8f9fa;
    display: none;
}

.vertical-menu .menu-item:hover .submenu {
    display: block;
}

.vertical-menu .submenu-link {
    display: block;
    padding: 10px 30px;
    color: #666;
    font-size: 0.9em;
}

.vertical-menu .submenu-link:hover {
    background: #e9ecef;
    color: #007bff;
}

/* Мегаменю в стиле Pangaia - базовые стили, размеры устанавливает JS */
.dropdown-mega .dropdown-menu {
    /* Ширина, позиция и position устанавливаются JavaScript */
    margin: 0;
    padding: 0;
    border-radius: 0;
    border: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    z-index: 1050;
    overflow: hidden;
    min-height: 300px;
    /* Убираем трансформации которые могут мешать */
    transform: none !important;
    -webkit-transform: none !important;
}

/* Стили для мобильного offcanvas меню */
.offcanvas {
    position: fixed !important;
    top: 0 !important;
    bottom: 0 !important;
    z-index: 1060 !important;
    width: 320px !important;
    max-width: 85vw !important;
    background-color: #fff !important;
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15) !important;
    transform: translateX(100%) !important;
    transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
    visibility: hidden !important;
    border-left: 1px solid #e9ecef !important;
}

.offcanvas.show {
    transform: translateX(0);
    visibility: visible;
}

.offcanvas.offcanvas-end {
    right: 0;
    transform: translateX(100%);
}

.offcanvas.offcanvas-end.show {
    transform: translateX(0);
}

.offcanvas-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.15s linear;
}

.offcanvas-backdrop.show {
    opacity: 1;
}

.offcanvas-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1rem;
    border-bottom: 1px solid #dee2e6;
}

.offcanvas-title {
    margin: 0;
    line-height: 1.5;
}

.btn-close {
    width: 1em;
    height: 1em;
    padding: 0.25em;
    background: transparent;
    border: 0;
    border-radius: 0.25rem;
    opacity: 0.5;
    cursor: pointer;
}

.btn-close:hover {
    opacity: 0.75;
}

.offcanvas-body {
    flex-grow: 1;
    padding: 1rem 1rem;
    overflow-y: auto;
}

/* Мобильная кнопка меню */
.mobile-menu-toggle {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 48px !important;
    height: 48px !important;
    background: #fff !important;
    border: 2px solid #6c757d !important;
    border-radius: 10px !important;
    cursor: pointer !important;
    transition: all 0.2s ease-in-out !important;
    position: relative !important;
    z-index: 1051 !important;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15) !important;
    margin: 0 8px !important;
}

.mobile-menu-toggle:hover {
    background-color: #007bff !important;
    border-color: #007bff !important;
    transform: scale(1.08) !important;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3) !important;
}

.mobile-menu-toggle:active {
    transform: scale(0.95) !important;
    box-shadow: 0 2px 4px rgba(0,123,255,0.2) !important;
}

.mobile-menu-toggle:focus {
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.25) !important;
}

.mobile-menu-toggle i {
    font-size: 1.5rem !important;
    color: #495057 !important;
    transition: color 0.2s ease !important;
    font-weight: bold !important;
}

.mobile-menu-toggle:hover i {
    color: #fff !important;
}

/* Визуальная индикация кликабельности */
.mobile-menu-toggle::after {
    content: "" !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    width: 0 !important;
    height: 0 !important;
    border-radius: 50% !important;
    background: rgba(0,123,255,0.1) !important;
    transform: translate(-50%, -50%) !important;
    transition: width 0.3s ease, height 0.3s ease !important;
    pointer-events: none !important;
}

.mobile-menu-toggle:active::after {
    width: 60px !important;
    height: 60px !important;
}

.dropdown-mega .dropdown-menu.show {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

/* Контейнер без Bootstrap отступов */
.mega-content-container {
        width: 100%;
    padding: 0;
    margin: 0;
    margin-right: 400px; /* Отступ для видео */
    }
    
    .mega-content {
    padding: 2rem;
    margin: 0;
    width: 100%;
}

/* Минимальные переопределения Bootstrap для корректной работы */
.dropdown-mega .container,
.dropdown-mega .container-fluid {
    /* Убираем отступы которые могут мешать позиционированию */
    padding-left: 0 !important;
    padding-right: 0 !important;
}/* Переопределяем отступы navbar только для мегаменю */
.dropdown-mega .navbar .container-fluid {
    padding-left: 0 !important;
}

.mega-content h6 {
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #000;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.mega-content li {
    list-style: none;
    margin-bottom: 0.5rem;
}

.mega-content a {
    color: #000;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s ease;
}

.mega-content a:hover {
    text-decoration: underline;
    color: #007bff;
}

.mega-content ul {
    margin: 0;
    padding: 0;
}

/* Видео в мегаменю */
.mega-video {
    position: absolute;
    top: 0;
    right: 0;
    width: 400px;
    height: 100%;
    overflow: hidden;
}

.mega-video video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Адаптивность для мегаменю */
@media (max-width: 992px) {
    .mega-content-container {
        margin-right: 0; /* Убираем отступ для видео на мобильных */
    }

    .mega-content {
        max-width: none;
    }

    .mega-video {
        display: none; /* Скрываем видео на мобильных */
    }

    /* Также убираем все отступы на мобильных */
    .dropdown-mega .container,
    .dropdown-mega .container-fluid,
    .dropdown-mega .row {
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

@media (max-width: 768px) {
    .mega-content {
        padding: 1rem;
    }

    .mega-content .col-2 {
        margin-bottom: 1rem;
    }

    .dropdown-mega .dropdown-menu {
        /* Размеры устанавливаются JavaScript */
        left: 0;
        margin-left: 0;
    }
}

/* Выделенные пункты */
.featured {
    position: relative;
}

.featured::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 6px;
    height: 6px;
    background: #ff6b6b;
    border-radius: 50%;
}

/* Адаптивность */
@media (max-width: 1024px) {
    .mega-container {
        flex-direction: column;
        padding: 30px 20px;
    }
    
    .mega-video {
        width: 100%;
        height: 250px;
        min-height: 250px;
        order: -1;
    }
}

@media (max-width: 992px) {
    /* Скрываем десктопное меню на планшетах и мобильных */
    .mega-menu .menu-list.mega {
        display: none !important;
    }

    /* Показываем мобильную кнопку меню */
    .d-lg-none {
        display: block !important;
    }

    /* Стили для мобильного offcanvas */
    .offcanvas {
        width: 280px !important;
        max-width: 85vw !important;
    }

    /* Увеличиваем кнопку меню для лучшей доступности */
    .mobile-menu-toggle {
        width: 50px !important;
        height: 50px !important;
        margin: 0 10px !important;
    }

    .mobile-menu-toggle i {
        font-size: 1.6rem !important;
    }
}

@media (max-width: 768px) {
    .horizontal-menu { display: none; }
    .mega-categories { 
        grid-template-columns: repeat(2, minmax(160px, 1fr)); gap: 12px;
    }

    /* Дополнительные стили для маленьких экранов */
    .offcanvas {
        width: 260px !important;
        max-width: 90vw !important;
    }

    .mobile-menu-toggle {
        width: 48px !important;
        height: 48px !important;
    }
}

@media (min-width: 769px) {
    .mobile-menu {
        display: none;
    }
}
</style>

<script>
// JavaScript для мегаменю и мобильного меню
document.addEventListener('DOMContentLoaded', function() {
    // Функция для установки ширины и позиции мега-меню
    function setMegaMenuDimensions() {
        // Используем viewport размеры вместо body для точного позиционирования
        const viewportWidth = window.innerWidth;

        // Находим navbar с учетом его позиции на странице
        const navbar = document.querySelector('.navbar');
        let navbarTop = 0;
        if (navbar) {
            const navbarRect = navbar.getBoundingClientRect();
            navbarTop = navbarRect.bottom; // Используем нижнюю границу navbar
        }

        // Применяем к всем мега-меню
        document.querySelectorAll('.dropdown-mega .dropdown-menu').forEach(function(menu) {
            menu.style.width = viewportWidth + 'px';
            menu.style.position = 'fixed';
            menu.style.left = '0px';
            menu.style.top = navbarTop + 'px';
            menu.style.right = 'auto';
            menu.style.marginLeft = '0px';
            // Убеждаемся, что меню не блокирует клики
            menu.style.pointerEvents = 'auto';
            menu.style.zIndex = '1050';
        });
    }

    // Вызываем при загрузке страницы
    setMegaMenuDimensions();

    // Инициализация Bootstrap offcanvas компонентов
    function initializeOffcanvas() {
        // Находим все offcanvas элементы
        const offcanvasElements = document.querySelectorAll('.offcanvas');

        offcanvasElements.forEach(function(offcanvas) {
            // Создаем backdrop только когда нужно
            let backdrop = null;

            // Находим кнопку открытия
            const toggleBtn = document.querySelector('[data-bs-target="#' + offcanvas.id + '"]');

            if (toggleBtn) {
                // Убеждаемся, что кнопка видима и кликабельна
                toggleBtn.style.display = 'flex';
                toggleBtn.style.alignItems = 'center';
                toggleBtn.style.justifyContent = 'center';

                toggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Создаем backdrop при первом открытии
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'offcanvas-backdrop';
                        backdrop.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            z-index: 1040;
                            width: 100vw;
                            height: 100vh;
                            background-color: rgba(0, 0, 0, 0.5);
                            opacity: 0;
                            transition: opacity 0.15s linear;
                            pointer-events: auto;
                        `;
                        document.body.appendChild(backdrop);

                        // Убеждаемся, что backdrop не блокирует клики по умолчанию
                        backdrop.style.pointerEvents = 'auto';
                    }

                    offcanvas.classList.add('show');
                    backdrop.classList.add('show');
                    document.body.style.overflow = 'hidden';

                    // Добавляем обработчик клика на backdrop для закрытия
                    backdrop.addEventListener('click', function() {
                        offcanvas.classList.remove('show');
                        backdrop.classList.remove('show');
                        setTimeout(() => {
                            if (backdrop && backdrop.parentNode) {
                                backdrop.parentNode.removeChild(backdrop);
                                backdrop = null;
                            }
                        }, 150);
                        document.body.style.overflow = '';
                    });
                });
            }

            // Находим кнопку закрытия
            const closeBtn = offcanvas.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    offcanvas.classList.remove('show');
                    if (backdrop) {
                        backdrop.classList.remove('show');
                        // Удаляем backdrop через некоторое время
                        setTimeout(() => {
                            if (backdrop && backdrop.parentNode) {
                                backdrop.parentNode.removeChild(backdrop);
                                backdrop = null;
                            }
                        }, 150);
                    }
                    document.body.style.overflow = '';
                });
            }

            // Закрытие по нажатию клавиши Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && offcanvas.classList.contains('show')) {
                    offcanvas.classList.remove('show');
                    if (backdrop) {
                        backdrop.classList.remove('show');
                        setTimeout(() => {
                            if (backdrop && backdrop.parentNode) {
                                backdrop.parentNode.removeChild(backdrop);
                                backdrop = null;
                            }
                        }, 150);
                    }
                    document.body.style.overflow = '';
                }
            });
        });
    }

    // Функция для закрытия всех открытых offcanvas меню
    function closeAllOffcanvas() {
        document.querySelectorAll('.offcanvas.show').forEach(function(offcanvas) {
            offcanvas.classList.remove('show');
        });
        document.querySelectorAll('.offcanvas-backdrop').forEach(function(backdrop) {
            backdrop.classList.remove('show');
            // Удаляем backdrop через некоторое время
            setTimeout(() => {
                if (backdrop && backdrop.parentNode) {
                    backdrop.parentNode.removeChild(backdrop);
                }
            }, 150);
        });
        document.body.style.overflow = '';
    }

    // Очистка существующих backdrop элементов при загрузке
    function cleanupExistingBackdrops() {
        document.querySelectorAll('.offcanvas-backdrop').forEach(function(backdrop) {
            if (backdrop.parentNode) {
                backdrop.parentNode.removeChild(backdrop);
            }
        });
    }

    // Вызываем очистку перед инициализацией
    cleanupExistingBackdrops();

    // Инициализируем offcanvas
    initializeOffcanvas();

    // Дополнительная инициализация для мобильных устройств
    function initializeMobileMenu() {
        // Проверяем, что мы на мобильном устройстве
        if (window.innerWidth < 992) {
            const mobileButtons = document.querySelectorAll('.mobile-menu-toggle');

            mobileButtons.forEach(function(button) {
                // Убеждаемся, что кнопка правильно отображается
                button.style.display = 'flex';
                button.style.visibility = 'visible';
                button.style.opacity = '1';

                // Добавляем визуальную индикацию кликабельности
                button.style.position = 'relative';
                button.style.zIndex = '20';
            });
        }
    }

    // Вызываем инициализацию мобильного меню
    initializeMobileMenu();

    // Повторная инициализация при изменении размера окна
    window.addEventListener('resize', function() {
        initializeMobileMenu();
    });

    // Обработка мегаменю
    const megaDropdowns = document.querySelectorAll('.dropdown-mega');
    let hideTimeout;

    megaDropdowns.forEach(function(dropdown) {
        const toggle = dropdown.querySelector('.dropdown-toggle');
        const menu = dropdown.querySelector('.dropdown-menu');

        if (toggle && menu) {
            // Обработка наведения мыши для десктопа
            dropdown.addEventListener('mouseenter', function() {
                if (window.innerWidth >= 992) { // Только на десктопе
                    clearTimeout(hideTimeout);
                    // Устанавливаем размеры перед показом
                    setMegaMenuDimensions();
                    menu.classList.add('show');
                }
            });

            // Обработка ухода мыши с главного пункта
            dropdown.addEventListener('mouseleave', function(e) {
                if (window.innerWidth >= 992) { // Только на десктопе
                    // Увеличиваем задержку скрытия до 700мс для более плавной работы
                    hideTimeout = setTimeout(() => {
                        // Проверяем, находится ли курсор в разумной близости от меню
                        const rect = menu.getBoundingClientRect();
                        const mouseX = e.clientX;
                        const mouseY = e.clientY;

                        // Создаем зону комфорта 50px вокруг меню
                        const comfortZone = 50;
                        const extendedRect = {
                            left: rect.left - comfortZone,
                            right: rect.right + comfortZone,
                            top: rect.top - comfortZone,
                            bottom: rect.bottom + comfortZone
                        };

                        // Скрываем только если курсор далеко от меню
                        if (mouseX < extendedRect.left || mouseX > extendedRect.right ||
                            mouseY < extendedRect.top || mouseY > extendedRect.bottom) {
                            menu.classList.remove('show');
                        }
                    }, 700); // Увеличили задержку для плавности
                }
            });

            // Обработка наведения на само меню
            menu.addEventListener('mouseenter', function() {
                if (window.innerWidth >= 992) {
                    clearTimeout(hideTimeout);
                }
            });

            // Обработка ухода мыши с меню
            menu.addEventListener('mouseleave', function(e) {
                if (window.innerWidth >= 992) {
                    // Добавляем дополнительную задержку для плавности
                    hideTimeout = setTimeout(() => {
                        // Сначала проверяем, не перешли ли мы на другой элемент мега-меню
                        const relatedTarget = e.relatedTarget;
                        const isMovingToAnotherMenu = relatedTarget &&
                            (relatedTarget.closest('.dropdown-mega') === dropdown ||
                             relatedTarget.closest('.dropdown-menu') === menu);

                        if (!isMovingToAnotherMenu) {
                            // Если не перешли на другой элемент, проверяем расстояние курсора
                            const rect = menu.getBoundingClientRect();
                            const mouseX = e.clientX;
                            const mouseY = e.clientY;

                            // Создаем зону комфорта 30px вокруг меню
                            const comfortZone = 30;
                            const extendedRect = {
                                left: rect.left - comfortZone,
                                right: rect.right + comfortZone,
                                top: rect.top - comfortZone,
                                bottom: rect.bottom + comfortZone
                            };

                            // Скрываем только если курсор далеко от меню
                            if (mouseX < extendedRect.left || mouseX > extendedRect.right ||
                                mouseY < extendedRect.top || mouseY > extendedRect.bottom) {
                                menu.classList.remove('show');
                            }
                        }
                    }, 800); // Увеличили задержку для более плавной работы
                }
            });

            // Обработка клика для мобильных устройств
            toggle.addEventListener('click', function(e) {
                if (window.innerWidth < 992) { // Только на мобильных
                    e.preventDefault();
                    // Устанавливаем размеры перед показом
                    setMegaMenuDimensions();
                    menu.classList.toggle('show');
                }
            });
        }
    });

    // Закрытие мегаменю и offcanvas при клике вне их
    document.addEventListener('click', function(event) {
        // Проверяем, что клик был не на элементе мега-меню и не на offcanvas
        if (!event.target.closest('.dropdown-mega') && !event.target.closest('.dropdown-menu') &&
            !event.target.closest('.offcanvas') && !event.target.closest('.offcanvas-backdrop')) {
            clearTimeout(hideTimeout);
            // Закрываем мега-меню на десктопе
            document.querySelectorAll('.dropdown-mega .dropdown-menu').forEach(function(menu) {
                if (window.innerWidth >= 992) {
                    menu.classList.remove('show');
                }
            });
            // Закрываем все offcanvas меню
            closeAllOffcanvas();
        }
    });

    // Также добавляем обработчик для клика на пустом пространстве страницы
    document.addEventListener('mousedown', function(event) {
        // Если клик был на body или html (но не на других элементах)
        if ((event.target === document.body || event.target === document.documentElement) &&
            !event.target.closest('.dropdown-mega') && !event.target.closest('.offcanvas')) {
            clearTimeout(hideTimeout);
            document.querySelectorAll('.dropdown-mega .dropdown-menu').forEach(function(menu) {
                if (window.innerWidth >= 992) {
                    menu.classList.remove('show');
                }
            });
            closeAllOffcanvas();
        }
    });

    // Обработка изменения размера окна
    window.addEventListener('resize', function() {
        clearTimeout(hideTimeout);
        // Обновляем размеры при изменении окна
        setMegaMenuDimensions();

        // Закрываем все открытые меню при изменении размера
        document.querySelectorAll('.dropdown-mega .dropdown-menu').forEach(function(menu) {
            menu.classList.remove('show');
        });
        closeAllOffcanvas();
        cleanupExistingBackdrops();
    });

    // Обработка выгрузки страницы для очистки
    window.addEventListener('beforeunload', function() {
        closeAllOffcanvas();
        cleanupExistingBackdrops();
    });

    // Обработка скролла страницы для sticky navbar
    window.addEventListener('scroll', function() {
        // Обновляем позицию меню при скролле, если оно открыто
        const openMenus = document.querySelectorAll('.dropdown-mega .dropdown-menu.show');
        if (openMenus.length > 0) {
            setMegaMenuDimensions();
        }
    });
});

// JavaScript для мобильного меню
function toggleMobileMenu() {
    const overlay = document.getElementById('mobileMenuOverlay');
    const content = document.getElementById('mobileMenuContent');
    
    overlay.classList.toggle('show');
    content.classList.toggle('show');
}

function closeMobileMenu() {
    const overlay = document.getElementById('mobileMenuOverlay');
    const content = document.getElementById('mobileMenuContent');
    
    overlay.classList.remove('show');
    content.classList.remove('show');
}

function toggleMobileSubmenu(index) {
    const submenu = document.getElementById(`submenu-${index}`);
    const toggle = submenu.previousElementSibling.querySelector('.mobile-submenu-toggle i');
    
    submenu.classList.toggle('show');
    toggle.classList.toggle('fa-chevron-down');
    toggle.classList.toggle('fa-chevron-up');
}

// Закрытие меню при клике вне его
document.addEventListener('click', function(event) {
    const menuContent = document.getElementById('mobileMenuContent');
    const menuToggle = document.querySelector('.mobile-menu-toggle');
    
    if (menuContent && menuToggle && 
        !menuContent.contains(event.target) && 
        !menuToggle.contains(event.target)) {
        closeMobileMenu();
    }
});
</script>