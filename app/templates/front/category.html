{% include 'front/header.html' %}

{% block content %}
<main class="container-fluid main p-3">
    <!-- CATEGORY HEADER AND SUBCATEGORIES -->
    <section class="catalogue row">
        <div class="col-12 col-lg-6 d-flex flex-column align-items-center justify-content-center">
            <div class="w-500">
                <nav aria-label="breadcrumb">
                    <div class="d-flex overflow-auto flex-nowrap mb-4">
                        <ol class="breadcrumb mb-0 d-flex flex-nowrap text-nowrap gap-2 align-items-center" role="list">
                            <li class="breadcrumb-item" role="listitem">
                                <a href="../index.html"
                                   class="breadcrumb-link f-size-10 f-color-breadcrumb-gray text-decoration-none">–ì–ª–∞–≤–Ω–∞—è</a>
                            </li>
                            <li class="breadcrumb-item f-size-12" aria-current="page" role="listitem">
                                <a href="./catalogue.html" class="breadcrumb-link color-black text-decoration-none">–ö–∞—Ç–∞–ª–æ–≥</a>
                            </li>
                        </ol>
                    </div>
                </nav>
                <div class="catalogue-header">
                    <h1 class="catalogue-header-title f-weight-600 f-size-24 m-0 mt-lg-4">{{category.name}}</h1>
                    <p class="catalogue-header-text f-size-14 m-0 mt-lg-4">{{category.description| safe}}</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="row row-cols-md-5 row-cols-2 px-0">
                {% for cat in subCategories %}
                <div class="col p-1">
                    <div class="card">
                        <a class="card product_item" href="/category/{{cat.slug}}">
                            <div class="cat-image">
                                <img src="/static/uploads/{{cat.image.filename}}" class="img-thumbnail w-100">
                            </div>
                            <div class="product_info p-2" style="position: absolute; bottom: 0.1em">
                                <p class="text-white mb-0" style="font-size: 12px">{{cat.name}}</p>
                            </div>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- SORTING AND FILTERING -->
    <section class="sorting-and-filtering py-2 d-flex justify-content-end my-5">
        <button id="open-filter-btn"
                class="btn btn-dark px-4 py-3 d-flex align-items-center gap-3"
                data-bs-toggle="offcanvas" 
                data-bs-target="#filterOffcanvas">
            –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                      d="M2.02979 2.55001V0H3.02979V2.55001C4.17091 2.78164 5.02979 3.79052 5.02979 5C5.02979 6.20948 4.17091 7.21836 3.02979 7.44999V16H2.02979V7.44999C0.888665 7.21836 0.0297852 6.20948 0.0297852 5C0.0297852 3.79052 0.888665 2.78164 2.02979 2.55001ZM7.02979 8.55001C5.88867 8.78164 5.02979 9.79052 5.02979 11C5.02979 12.2095 5.88867 13.2184 7.02979 13.45V16H8.02979V13.45C9.17091 13.2184 10.0298 12.2095 10.0298 11C10.0298 9.79052 9.17091 8.78164 8.02979 8.55001V0H7.02979V8.55001ZM12.0298 2.55001V0H13.0298V2.55001C14.1709 2.78164 15.0298 3.79052 15.0298 5C15.0298 6.20948 14.1709 7.21836 13.0298 7.44999V16H12.0298V7.44999C10.8887 7.21836 10.0298 6.20948 10.0298 5C10.0298 3.79052 10.8887 2.78164 12.0298 2.55001ZM2.52979 3.5C1.70136 3.5 1.02979 4.17157 1.02979 5C1.02979 5.82843 1.70136 6.5 2.52979 6.5C3.35822 6.5 4.02979 5.82843 4.02979 5C4.02979 4.17157 3.35822 3.5 2.52979 3.5ZM12.5298 3.5C11.7014 3.5 11.0298 4.17157 11.0298 5C11.0298 5.82843 11.7014 6.5 12.5298 6.5C13.3582 6.5 14.0298 5.82843 14.0298 5C14.0298 4.17157 13.3582 3.5 12.5298 3.5ZM7.52979 9.5C6.70135 9.5 6.02979 10.1716 6.02979 11C6.02979 11.8284 6.70135 12.5 7.52979 12.5C8.35822 12.5 9.02979 11.8284 9.02979 11C9.02979 10.1716 8.35822 9.5 7.52979 9.5Z"
                      fill="white"/>
            </svg>
        </button>
    </section>

    <!-- FILTER OFFCANVAS -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel">
        <div class="offcanvas-header border-0 pb-0">
            <h5 class="offcanvas-title fw-bold fs-4" id="filterOffcanvasLabel">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body px-4 py-3">
            <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
            <div class="filter-section mb-4">
                <h6 class="fw-bold mb-3">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h6>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-dark rounded-0 px-3 py-2 sort-option" data-sort="new">–ù–æ–≤—ã–µ</button>
                    <button class="btn btn-dark rounded-0 px-3 py-2 sort-option active" data-sort="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
                    <button class="btn btn-outline-dark rounded-0 px-3 py-2 sort-option" data-sort="price_asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</button>
                    <button class="btn btn-outline-dark rounded-0 px-3 py-2 sort-option" data-sort="price_desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</button>
                </div>
            </div>
            
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –æ–ø—Ü–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤ -->
            {% for option in filter_options %}
            <div class="filter-section mb-4" data-option-id="{{ option.id }}">
                <h6 class="fw-bold mb-3">{{ option.name }}</h6>

                {% if 'color' in (option.display_type|string)|lower %}
                  <div class="color-row filters-color">
                    <div class="swatches-scroll">
                      {% for value in option.option_values %}
                        <div class="color-dot filter-value pallete-color pallete-color-{{ value.value | lower | replace(' ', '-') }}"
                             data-option-id="{{ option.id }}"
                             data-value-id="{{ value.id }}"
                             data-value="{{ value.value }}"
                             title="{{ value.value }} ({{ value.count }})"></div>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  <div class="d-flex flex-wrap gap-2">
                    {% for value in option.option_values %}
                      <button class="btn btn-outline-dark rounded-0 px-3 py-2 filter-value"
                              data-option-id="{{ option.id }}"
                              data-value-id="{{ value.id }}"
                              data-value="{{ value.value }}">
                        {{ value.value }} ({{ value.count }})
                      </button>
                    {% endfor %}
                  </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <div class="offcanvas-footer border-0 pt-0 px-4 pb-4">
            <div class="d-flex gap-3 w-100">
                <button type="button" class="btn btn-primary flex-fill py-3" id="apply-filters">
                    –ü–æ–∫–∞–∑–∞—Ç—å <span id="results-count">{{ cat_products|length }}</span> —Ç–æ–≤–∞—Ä–æ–≤
                </button>
                <button type="button" class="btn btn-outline-primary flex-fill py-3" id="clear-filters">
                    –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>

    <!-- PRODUCTS -->
    <section class="products">
        <div class="row">
            {% for product in cat_products %}
            <div class="col-6 col-lg-3 mb-5 product-item">
                <div class="product-card position-relative h-100">
                    <span class="fav-btn" data-product-id="{{product.id}}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                        </svg>
                    </span>

                    <a href="{{ url_for('main.product', product_slug=product.slug) }}" data-product-id="{{product.id}}" class="product_item d-block">
                        <div class="product-image-container">
                            {% set product_images = product_images_data.get(product.id, []) %}
                            {% if product_images|length > 1 %}
                            <div class="product-image-slider" data-product-id="{{ product.id }}">
                                {% for image in product_images %}
                                <div class="product-image-slide {% if loop.first %}active{% endif %}">
                                    <img src="/static/uploads/{{ image.filename }}" alt="{{ product.name }}" class="img-fluid w-100" data-image-index="{{ loop.index0 }}">
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="product-image">
                                <img src="/static/uploads/{{ product.main_image.filename }}" alt="{{ product.name }}" class="img-fluid w-100">
                            </div>
                            {% endif %}
                        </div>
                    </a>

                    <div class="product-info pt-2">
                        <a href="{{ url_for('main.product', product_slug=product.slug) }}" class="text-decoration-none text-dark d-block">
                            <div class="product-title text-truncate">{{ product.name }}</div>
                        </a>
                        <div class="d-flex align-items-center justify-content-between mt-1">
                            <div class="product-price fw-semibold">{{ product.price }} —Ä.</div>
                            <button class="cat-catalog-btn add-to-cart-btn" id="add-to-cart" style="border: none; background: transparent">
                                <img src="/static/icons/add-cart.png">
                            </button>
                        </div>
                        <div class="color-options mt-2">
                            {% set options = product_options[product.id] %}
                            {% set ns = namespace(total=0) %}
                            {% for option in options %}
                                {% if 'color' in (option['display_type']|string)|lower %}
                                    {% set ns.total = ns.total + (option['values']|length) %}
                                {% endif %}
                            {% endfor %}

                            <div class="color-row">
                                <div class="swatches-scroll" id="swatches-{{ product.id }}">
                                    {% for option in options %}
                                        {% if 'color' in (option['display_type']|string)|lower %}
                                            {% for color in option['values'] %}
                                                <div class="color-dot pallete-color pallete-color-{{ color.value | lower | replace(' ', '-') }}"
                                                     title="{{ color.value | capitalize }}"
                                                     data-color-name="{{ color.value | capitalize }}"></div>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% if ns.total > 7 %}
                                <button type="button" class="swatch-next" data-target="swatches-{{ product.id }}" aria-label="–ï—â—ë —Ü–≤–µ—Ç–∞">‚Ä∫</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if loop.index % 4 == 0 and not loop.last %}
            <!-- Promotional item after every 4th product -->
            <div class="col-6 col-lg-3 mb-4 promotional-item pb-5"
                 data-bg-src="../img/promotion/promotion{% if loop.index % 8 == 0 %}2{% else %}1{% endif %}.jpg">
                <div class="d-flex flex-column align-items-center align-items-lg-start justify-content-end h-100">
                    <h2 class="f-size-14 f-lh-34 f-weight-400 m-0 p-0 color-white text-start d-none d-lg-block">
                        –£ –Ω–∞—Å —Å–∫–∏–¥–∫–∏
                    </h2>
                    <p class="f-lh-18 f-lh-lg-24 m-0 p-0 color-white text-center text-lg-start mt-2 f-size-12 f-size-lg-14">
                        –ü—Ä–∏–æ–±—Ä–µ—Ç–∞–π—Ç–µ –Ω–µ–ø–æ–¥–≤–ª–∞—Å—Ç–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑–¥–µ–ª–∏—è —Å–æ —Å–∫–∏–¥–∫–æ–π –¥–æ 70%,
                        –∫–æ—Ç–æ—Ä—ã–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥—É–º–∞–Ω—ã –∏ –ø—Ä–æ—Å–ª—É–∂–∞—Ç –¥–æ–ª–≥–æ.
                    </p>
                    <a href="#"
                       class="button-animation f-size-12 f-lh-16 color-black background-color-white py-3 px-4 border-none border-radius-50 transition text-decoration-none mt-3">
                        –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
                    </a>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </section>
</main>
{% endblock %}
<script src="/static/js/product.js"></script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-option {
    font-size: 12px !important;
    padding: 4px 8px !important;
    border: 1px solid #ddd;
    background: white;
    transition: all 0.2s ease;
}

.filter-option:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.filter-option.active {
    background: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –ø–∞–ª–∏—Ç—Ä */
.pallete-color {
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.pallete-color:hover {
    border-color: #007bff;
    transform: scale(1.1);
}

.pallete-color.active {
    border-color: #007bff;
    transform: scale(1.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ */
.product-image-container {
    position: relative;
    overflow: hidden;
    width: 100%;
    aspect-ratio: 3/4;
    height: auto;
}

.product-image-slider {
    position: relative;
    width: 100%;
    height: 100%;
}

.product-image-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    display: block; /* –í–∞–∂–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
}

.product-image-slide.active {
    opacity: 1;
    z-index: 1; /* –ê–∫—Ç–∏–≤–Ω—ã–π —Å–ª–∞–π–¥ –ø–æ–≤–µ—Ä—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö */
}

.product-image-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block; /* –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
}

/* –û–±—ã—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ —Å–ª–∞–π–¥–µ—Ä) */
.product-image { width: 100%; height: 100%; }

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.product-item:hover .product-image-slide {
    transition: opacity 0.5s ease-in-out;
}

/* –ù–æ–≤—ã–π –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.product-card { border: none; }
.product-title { font-size: 14px; }
.product-price { font-size: 14px; }
.color-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid transparent; }
.color-dot.active, .color-dot:hover { border-color: #0d6efd; }

@media (min-width: 992px) {
  .product-title { font-size: 15px; }
  .product-price { font-size: 15px; }
}
</style>

<script>
let selectedFilters = {};
let selectedSort = 'popular';

$(document).ready(function() {
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–ò–õ–¨–¢–†–û–í –ö–ê–¢–ï–ì–û–†–ò–ò ===');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    initCategoryFilters();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    if (typeof initFavorites === 'function') {
        initFavorites();
    }
});

function initCategoryFilters() {
    console.log('–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', $('.filter-value.active, .sort-option.active').length);
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
    $('.filter-value, .sort-option').removeClass('active');
    console.log('–£–±—Ä–∞–Ω—ã –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å —Ñ–∏–ª—å—Ç—Ä–æ–≤');
    console.log('–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:', $('.filter-value.active, .sort-option.active').length);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    $('.sort-option[data-sort="popular"]').addClass('active');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
    $(document).on('click', '.filter-value', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const optionId = $(this).data('option-id');
        const valueId = $(this).data('value-id');
        const value = $(this).data('value');
        
        console.log('=== –ö–õ–ò–ö –ü–û –§–ò–õ–¨–¢–†–£ ===');
        console.log('optionId:', optionId, '(—Ç–∏–ø:', typeof optionId, ')');
        console.log('valueId:', valueId, '(—Ç–∏–ø:', typeof valueId, ')');
        console.log('value:', value);
        console.log('–î–æ –∫–ª–∏–∫–∞ selectedFilters:', JSON.stringify(selectedFilters));
        
        const wasActive = $(this).hasClass('active');
        $(this).toggleClass('active');
        const isActive = $(this).hasClass('active');
        
        console.log('–ë—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ:', wasActive, '–°—Ç–∞–ª–æ –∞–∫—Ç–∏–≤–Ω–æ:', isActive);
        
        if (isActive) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            if (!selectedFilters[optionId]) {
                selectedFilters[optionId] = [];
                console.log('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è optionId:', optionId);
            }
            selectedFilters[optionId].push(valueId);
            console.log('‚úÖ –î–û–ë–ê–í–õ–ï–ù valueId:', valueId, '–≤ –º–∞—Å—Å–∏–≤ –¥–ª—è optionId:', optionId);
        } else {
            // –£–¥–∞–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            if (selectedFilters[optionId]) {
                const index = selectedFilters[optionId].indexOf(valueId);
                if (index > -1) {
                    selectedFilters[optionId].splice(index, 1);
                    console.log('‚ùå –£–î–ê–õ–ï–ù valueId:', valueId, '–∏–∑ –º–∞—Å—Å–∏–≤–∞ –¥–ª—è optionId:', optionId);
                }
                
                // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                if (selectedFilters[optionId].length === 0) {
                    delete selectedFilters[optionId];
                    console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è optionId:', optionId);
                }
            }
        }
        
        console.log('–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è selectedFilters:', JSON.stringify(selectedFilters));
        console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –≤ selectedFilters:', Object.keys(selectedFilters).length);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
    $(document).on('click', '.sort-option', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const sortValue = $(this).data('sort');
        console.log('=== –ö–õ–ò–ö –ü–û –°–û–†–¢–ò–†–û–í–ö–ï ===');
        console.log('sortValue:', sortValue);
        
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        $('.sort-option').removeClass('active');
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
        $(this).addClass('active');
        
        selectedSort = sortValue;
        console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:', selectedSort);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    $('#apply-filters').on('click', function() {
        console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', selectedFilters);
        applyFilters();
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º offcanvas
        $('#filterOffcanvas').offcanvas('hide');
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    $('#clear-filters').on('click', function() {
        console.log('–û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤');
        clearFilters();
    });
}

function applyFilters() {
    console.log('=== –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –§–ò–õ–¨–¢–†–û–í ===');
    console.log('selectedFilters (—Ç–∏–ø):', typeof selectedFilters);
    console.log('selectedFilters (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ):', JSON.stringify(selectedFilters));
    console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –≤ selectedFilters:', Object.keys(selectedFilters).length);
    console.log('selectedSort:', selectedSort);
    
    // –ü–æ–ª—É—á–∞–µ–º slug –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ URL
    const pathParts = window.location.pathname.split('/');
    const categorySlug = pathParts[pathParts.length - 1];
    
    console.log('Category slug:', categorySlug);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    $('.products .row').html('<div class="col-12 text-center"><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    $.ajax({
        url: `/category/${categorySlug}/filter`,
        method: 'POST',
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        },
        data: JSON.stringify({
            filters: selectedFilters,
            sort: selectedSort
        }),
        success: function(response) {
            console.log('=== FILTER RESPONSE ===');
            console.log('Success:', response.success);
            console.log('Products count:', response.products_count);
            
            if (response.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º HTML —Ç–æ–≤–∞—Ä–æ–≤
                $('.products .row').html(response.products_html);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                if (response.products_count === 0) {
                    $('.products .row').html('<div class="col-12 text-center"><p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>');
                }
                
                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (typeof initProductCards === 'function') {
                    initProductCards();
                }
                if (typeof initColorPalette === 'function') {
                    initColorPalette();
                }
                if (typeof initAddToCart === 'function') {
                    initAddToCart();
                }
                if (typeof initFavorites === 'function') {
                    initFavorites();
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                initProductImageSliders();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –æ–ø—Ü–∏–π –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                if (typeof initFilteredProductOptions === 'function') {
                    initFilteredProductOptions();
                }
                
                console.log('‚úÖ –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', response.error);
                $('.products .row').html('<div class="col-12 text-center"><p>–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤</p></div>');
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå AJAX Error:', status, error);
            console.error('Response:', xhr.responseText);
            $('.products .row').html('<div class="col-12 text-center"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p></div>');
        }
    });
}

function clearFilters() {
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    $('.filter-value').removeClass('active');
    $('.sort-option').removeClass('active');
    $('.sort-option[data-sort="popular"]').addClass('active');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    selectedFilters = {};
    selectedSort = 'popular';
    
    console.log('–§–∏–ª—å—Ç—Ä—ã –æ—á–∏—â–µ–Ω—ã');
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    applyFilters();
}

function showSelectedFilters() {
    let filterText = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    for (const optionId in selectedFilters) {
        const values = selectedFilters[optionId];
        filterText += `–û–ø—Ü–∏—è ${optionId}: ${values.join(', ')}; `;
    }
    
    if (filterText) {
        console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:', filterText);
    } else {
        console.log('–§–∏–ª—å—Ç—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤
function initProductImageSliders() {
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–õ–ê–ô–î–ï–†–û–í –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ===');
    const sliders = $('.product-image-slider');
    console.log('–ù–∞–π–¥–µ–Ω–æ —Å–ª–∞–π–¥–µ—Ä–æ–≤:', sliders.length);
    
    sliders.each(function(index) {
        const $slider = $(this);
        const $slides = $slider.find('.product-image-slide');
        const totalSlides = $slides.length;
        const productId = $slider.data('product-id');
        
        console.log(`–°–ª–∞–π–¥–µ—Ä ${index + 1} (—Ç–æ–≤–∞—Ä ${productId}): ${totalSlides} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`);
        
        if (totalSlides <= 1) {
            console.log(`–°–ª–∞–π–¥–µ—Ä ${index + 1}: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (${totalSlides} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)`);
            return;
        }
        
        let currentSlide = 0;
        let slideInterval;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–∞–π–¥–∞
        function showNextSlide() {
            console.log(`–°–ª–∞–π–¥–µ—Ä ${productId}: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–∞`);
            console.log(`  –¢–µ–∫—É—â–∏–π —Å–ª–∞–π–¥: ${currentSlide + 1}`);
            console.log(`  –í—Å–µ–≥–æ —Å–ª–∞–π–¥–æ–≤: ${totalSlides}`);
            
            $slides.removeClass('active');
            currentSlide = (currentSlide + 1) % totalSlides;
            $slides.eq(currentSlide).addClass('active');
            
            console.log(`  –ù–æ–≤—ã–π —Å–ª–∞–π–¥: ${currentSlide + 1}`);
            console.log(`  –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª–∞–π–¥–æ–≤: ${$slides.filter('.active').length}`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª–∞–π–¥–∞
        function showPrevSlide() {
            $slides.removeClass('active');
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            $slides.eq(currentSlide).addClass('active');
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –º—ã—à–∏
        $slider.closest('.product-item').on('mouseenter', function() {
            console.log(`–°–ª–∞–π–¥–µ—Ä ${productId}: –Ω–∞–≤–µ–¥–µ–Ω–∏–µ –º—ã—à–∏`);
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ
            slideInterval = setInterval(showNextSlide, 1500); // 1.5 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É —Å–ª–∞–π–¥–∞–º–∏
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Ö–æ–¥–∞ –º—ã—à–∏
        $slider.closest('.product-item').on('mouseleave', function() {
            console.log(`–°–ª–∞–π–¥–µ—Ä ${productId}: —É—Ö–æ–¥ –º—ã—à–∏`);
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ
            if (slideInterval) {
                clearInterval(slideInterval);
                slideInterval = null;
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–µ—Ä–≤–æ–º—É —Å–ª–∞–π–¥—É
            $slides.removeClass('active');
            currentSlide = 0;
            $slides.eq(currentSlide).addClass('active');
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        $slider.on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log(`–°–ª–∞–π–¥–µ—Ä ${productId}: –∫–ª–∏–∫`);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ
            if (slideInterval) {
                clearInterval(slideInterval);
                slideInterval = null;
            }
            
            showNextSlide();
        });
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
$(document).ready(function() {
    initProductImageSliders();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –æ–ø—Ü–∏–π –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    if (typeof initFilteredProductOptions === 'function') {
        initFilteredProductOptions();
    }

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–∞–ª–∏—Ç—Ä—ã –ø–æ –∫–Ω–æ–ø–∫–µ "‚Ä∫"
    $(document).on('click', '.swatch-next', function(e) {
        e.preventDefault();
        const targetId = $(this).data('target');
        const $container = $('#'+targetId);
        const scrollX = 80; // —à–∏—Ä–∏–Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ—á–µ–∫
        $container.animate({ scrollLeft: $container.scrollLeft() + scrollX }, 200);
    });
});
</script>
{% include 'front/footer.html' %}